<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Glyph Assessment</title>
<style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
    .container { max-width: 600px; margin: 2rem auto; background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h2 { margin-top: 0; }
    .step { display: none; }
    .step.active { display: block; }
    .field-group { display: flex; gap: 1rem; margin-bottom: 1rem; flex-direction: column; }
    @media (min-width: 480px) { .field-group { flex-direction: row; } }
    input[type="text"] { padding: 0.5rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; width: 100%; }
    button { padding: 0.5rem 1rem; font-size: 1rem; background-color: #4f46e5; color: #fff; border: none; border-radius: 4px; cursor: pointer; margin-top: 1rem; }
    button:hover { background-color: #4338ca; }
    button:disabled { background-color: #9ca3af; cursor: not-allowed; }

    /* Testing reset button */
    .reset-btn { background-color: #ef4444; float: right; margin-top: -2rem; margin-bottom: 1rem; }
    .reset-btn:hover { background-color: #dc2626; }

    /* Ranking layout */
    .question-block { display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin: 0.5rem 0; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 4px; }
    .question-text { flex: 1; font-weight: bold; word-wrap: break-word; }

    .rank-buttons { display: flex; flex-direction: row; gap: 4px; min-width: 70px; align-items: center; }
    .rank-buttons button { width: 35px; height: 28px; font-size: 16px; padding: 0; background-color: #4f46e5; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .rank-buttons button:hover { background-color: #4338ca; }
        

    /* Confidence emojis */
    .emoji-feedback { display: flex; gap: 0.5rem; align-items: center; }
    .emoji-feedback span { font-size: 1.5rem; cursor: pointer; padding: 0.25rem; border-radius: 4px; transition: all 0.2s; }
    .emoji-feedback span:hover { transform: scale(1.2); background-color: #f3f4f6; }
    .emoji-selected { transform: scale(1.3) !important; background-color: #ddd6fe !important; border: 2px solid #4f46e5; }

    /* Q1/Q2 containers */
    #q1Container, #q2Container { margin-top: 1rem; padding: 1rem; background: #f9f9f9; border-radius: 6px; border: 1px solid #ddd; }

    /* Reflection styles */
    .reflection-options { display: flex; flex-direction: column; gap: 0.5rem; margin: 1rem 0; }
    .reflection-options label { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 4px; cursor: pointer; }
    .reflection-options label:hover { background-color: #f9fafb; }
    .reflection-options input[type="radio"] { margin: 0; }


    /* Validation messages */
    .validation-error { color: #ef4444; font-size: 0.875rem; margin-top: 0.5rem; }



        #debugPanel { display:none; margin-top: 1rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; background:#0f172a; color:#e2e8f0; padding: 1rem; border-radius:8px; }
        #debugPanel pre { white-space: pre-wrap; word-wrap: break-word; }
      </style>
<script>
        const questions = [
          { id: 'Q1', label: 'Simplify $3y + 5y - 2$' },
          { id: 'Q2', label: 'Evaluate $m^2 - \\dfrac{12}{m}$, when $m = 4$' },
          { id: 'Q3', label: 'Write $4(a-2)$ with no multiplication' },
          { id: 'Q4', label: 'Simplify $4x - 2(3x - 1) + 5$' },
          { id: 'Q5', label: 'You earn $35$ per hour tutoring. You already have $540$ in your savings. Write an expression for your total money after $h$ hours.' }
        ];

        let orderedQuestions = [...questions.map(q => q.id)];
        let confidenceMap = {};

        function getParam(name) {
          const url = new URL(window.location.href);
          return url.searchParams.get(name);
        }

        function typeset() { if (window.MathJax) MathJax.typesetPromise(); }

        function resetApp() {
          try {
            localStorage.clear();
          } catch (e) {
            console.warn('localStorage clear failed:', e);
          }
          orderedQuestions = [...questions.map(q => q.id)];
          confidenceMap = {};
          showStep('name');
          renderRank();
          if (getParam('debug') === 'true') logDebug('App reset to initial state.');
        }
        window.resetApp = resetApp;

        function showStep(step) {
          document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
          const target = document.getElementById(`step-${step}`);
          if (!target) return;
          target.classList.add('active');
          localStorage.setItem('current_step', step);
          
          if (step === 'rank') renderRank();
          if (step === 'confidence') renderConfidence();
          if (step === 'q1') renderQ1();
          if (step === 'q2') renderQ2();
          if (step === 'reflection') renderReflection();
          
          typeset();
        }

        function validateRanking() {
          return orderedQuestions.length === questions.length;
        }

        function validateConfidence() {
          return Object.keys(confidenceMap).length === questions.length;
        }

        function moveQuestion(idx, direction) {
          const newIdx = idx + direction;
          if (newIdx < 0 || newIdx >= orderedQuestions.length) return;
          [orderedQuestions[idx], orderedQuestions[newIdx]] = [orderedQuestions[newIdx], orderedQuestions[idx]];
          localStorage.setItem('orderedQuestions', JSON.stringify(orderedQuestions));
          renderRank();
        }

        function renderRank() {
          const container = document.getElementById('rankContainer');
          if (!container) return;
          container.innerHTML = '';
          orderedQuestions.forEach((id, i) => {
            const q = questions.find(q => q.id === id);
            const div = document.createElement('div');
            div.className = 'question-block';
            div.innerHTML = `
              <div class="question-text">${i + 1}. ${q.label}</div>
              <div class="rank-buttons">
                <button onclick="moveQuestion(${i}, -1)" ${i === 0 ? 'disabled' : ''}>‚¨ÜÔ∏è</button>
                <button onclick="moveQuestion(${i}, 1)" ${i === orderedQuestions.length - 1 ? 'disabled' : ''}>‚¨áÔ∏è</button>
              </div>
            `;
            container.appendChild(div);
          });
          typeset();
        }

        function proceedToConfidence() {
          if (!validateRanking()) {
            showValidationError('rankError', 'Please rank all questions before continuing.');
            return;
          }
          hideValidationError('rankError');
          showStep('confidence');
        }

        function renderConfidence() {
          const container = document.getElementById('confidenceContainer');
          if (!container) return;
          container.innerHTML = '';
          orderedQuestions.forEach(id => {
            const q = questions.find(q => q.id === id);
            const div = document.createElement('div');
            div.className = 'question-block';
            div.innerHTML = `
              <div><strong>${q.label}</strong></div>
              <div class="emoji-feedback">
                <span onclick="setConfidence('${id}',1,this)" title="Low confidence">üòü</span>
                <span onclick="setConfidence('${id}',2,this)" title="Medium confidence">üòê</span>
                <span onclick="setConfidence('${id}',3,this)" title="High confidence">üòÑ</span>
              </div>
            `;
            container.appendChild(div);
            
            const saved = confidenceMap[id];
            if (saved) {
              const spans = div.querySelectorAll('span');
              if (spans[saved - 1]) spans[saved - 1].classList.add('emoji-selected');
            }
          });
          typeset();
        }

        function setConfidence(qid, value, el) {
          confidenceMap[qid] = value;
          localStorage.setItem('confidence', JSON.stringify(confidenceMap));
          el.parentElement.querySelectorAll('span').forEach(e => e.classList.remove('emoji-selected'));
          el.classList.add('emoji-selected');
          if (getParam('debug') === 'true') logDebug(`Saved confidence ${value} for ${qid}`);
        }

        function proceedToQ1() {
          if (!validateConfidence()) {
            showValidationError('confidenceError', 'Please rate your confidence for all questions before continuing.');
            return;
          }
          hideValidationError('confidenceError');
          showStep('q1');
        }

        function showValidationError(id, message) {
          let errorEl = document.getElementById(id);
          if (!errorEl) {
            errorEl = document.createElement('div');
            errorEl.id = id;
            errorEl.className = 'validation-error';
            document.querySelector(`#step-${getCurrentStep()}`).appendChild(errorEl);
          }
          errorEl.textContent = message;
        }

        function hideValidationError(id) {
          const errorEl = document.getElementById(id);
          if (errorEl) errorEl.remove();
        }

        function getCurrentStep() {
          return localStorage.getItem('current_step') || 'name';
        }


        function selectQ1() {
          const confidence = JSON.parse(localStorage.getItem('confidence')) || {};
          const byConf = {1:[], 2:[], 3:[]};
          orderedQuestions.forEach(q => { const c = confidence[q]; if (c) byConf[c].push(q); });

          let q1;
          
          if (byConf[3].length >= 2) {
            q1 = byConf[3][byConf[3].length - 2];
          } else if (byConf[3].length >= 1 && byConf[2].length >= 1) {
            q1 = byConf[3][byConf[3].length - 1];
          } else if (byConf[2].length >= 1) {
            q1 = byConf[2][0];
          } else if (byConf[1].length >= 2) {
            q1 = byConf[1][1];
          } else if (byConf[1].length >= 1) {
            q1 = byConf[1][0];
          }

          if (!q1) q1 = orderedQuestions[Math.floor(orderedQuestions.length / 2)];

          localStorage.setItem('q1_id', q1);
          localStorage.setItem('q1_index', orderedQuestions.indexOf(q1));
          return q1;
        }
        

        function renderQ1() {
          const container = document.getElementById('q1Container');
          if (!container) return;

          const q1_id = selectQ1();
          const q1 = questions.find(q => q.id === q1_id);
          if (!q1) {
            container.innerHTML = '<p>Please complete the ranking and confidence steps first.</p>';
            return;
          }

          container.innerHTML = `
            <h3>Question 1: ${q1.label}</h3>
            <input id="q1Answer" type="text" placeholder="Enter your answer here" style="margin-top: 1rem; padding: 0.5rem; width: 100%;" />
            <button id="q1Submit">Submit Answer</button>
            <div id="q1Feedback" style="margin-top: 1rem; font-weight: bold;"></div>
          `;
          document.getElementById('q1Submit').onclick = gradeQ1;
          typeset();
        }


        function gradeQ1() {
          const q1_id = localStorage.getItem('q1_id');
          const q1 = questions.find(q => q.id === q1_id);
          const input = document.getElementById('q1Answer');
          const answer = (input?.value || '').trim();
          
          if (!answer) {
            alert('Please enter an answer before submitting.');
            return;
          }

          const isCorrect = checkAnswer(q1.id, answer);
          
          localStorage.setItem('q1_answer', answer);
          localStorage.setItem('q1_correct', isCorrect);
          
          if (getParam('debug') === 'true') logDebug(`Q1 ${q1.id} answer = "${answer}" -> ${isCorrect ? 'CORRECT' : 'INCORRECT'}`);

          selectQ2(isCorrect);
          showStep('q2');
        }

        function selectQ2(isCorrect) {
          const confidence = JSON.parse(localStorage.getItem('confidence')) || {};
          const q1 = localStorage.getItem('q1_id');
          const q1Idx = parseInt(localStorage.getItem('q1_index'));
          const q1Conf = confidence[q1];
          const unasked = orderedQuestions.filter(q => q !== q1);
          let q2 = null;

          if (!Number.isNaN(q1Idx) && q1Conf) {
            if (isCorrect) {
              for (let i = q1Idx + 1; i < orderedQuestions.length; i++) {
                const candidate = orderedQuestions[i];
                if (confidence[candidate] === q1Conf) { q2 = candidate; break; }
              }
            } else {
              for (let i = q1Idx - 1; i >= 0; i--) {
                const candidate = orderedQuestions[i];
                if (confidence[candidate] === q1Conf) { q2 = candidate; break; }
              }
            }
          }

          if (!q2) q2 = unasked[0];
          localStorage.setItem('q2_id', q2);
          return q2;
        }

        function renderQ2() {
          const container = document.getElementById('q2Container');
          if (!container) return;

          const q2_id = localStorage.getItem('q2_id');
          const q2 = questions.find(q => q.id === q2_id);
          if (!q2) {
            container.innerHTML = '<p>Q2 is not ready yet. Please answer Q1 first.</p>';
            return;
          }

          container.innerHTML = `
            <h3>Question 2: ${q2.label}</h3>
            <input id="q2Answer" type="text" placeholder="Enter your answer here" style="margin-top: 1rem; padding: 0.5rem; width: 100%;" />
            <button id="q2Submit">Submit Answer</button>
            <div id="q2Feedback" style="margin-top: 1rem; font-weight: bold;"></div>
          `;
          document.getElementById('q2Submit').onclick = gradeQ2;
          typeset();
        }

        function gradeQ2() {
          const q2_id = localStorage.getItem('q2_id');
          const q2 = questions.find(q => q.id === q2_id);
          const input = document.getElementById('q2Answer');
          const answer = (input?.value || '').trim();
          
          if (!answer) {
            alert('Please enter an answer before submitting.');
            return;
          }

          const isCorrect = checkAnswer(q2.id, answer);
          
          localStorage.setItem('q2_answer', answer);
          localStorage.setItem('q2_correct', isCorrect);
          
          if (getParam('debug') === 'true') logDebug(`Q2 ${q2.id} answer = "${answer}" -> ${isCorrect ? 'CORRECT' : 'INCORRECT'}`);

          showStep('reflection');
        }
        

        function renderReflection() {
          const container = document.getElementById('reflectionContainer');
          if (!container) return;

          const saved = localStorage.getItem('reflection_response');
          container.innerHTML = `
            <p>After solving the questions, how did the actual difficulty compare to your expectations?</p>
            <div class="reflection-options">
              <label>
                <input type="radio" name="reflection" value="easier" ${saved === 'easier' ? 'checked' : ''}>
                The questions were easier than expected
              </label>
              <label>
                <input type="radio" name="reflection" value="about-right" ${saved === 'about-right' ? 'checked' : ''}>
                About what I expected
              </label>
              <label>
                <input type="radio" name="reflection" value="harder" ${saved === 'harder' ? 'checked' : ''}>
                The questions were harder than expected
              </label>
            </div>
          `;

          container.querySelectorAll('input[name="reflection"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
              localStorage.setItem('reflection_response', e.target.value);
              if (getParam('debug') === 'true') logDebug(`Reflection saved: ${e.target.value}`);
            });
          });
        }

        function proceedToComplete() {
  const reflection = localStorage.getItem('reflection_response');
  if (!reflection) {
    showValidationError('reflectionError', 'Please select how the questions compared to your expectations.');
    return;
  }
  hideValidationError('reflectionError');
  
  // ‚úÖ Add this line:
  sendResultsToSheet();

  showStep('complete');
}


        function normalizeSpaces(s) { return s.replace(/\s+/g, ' ').trim(); }

        function checkAnswer(id, ans) {
          const a = normalizeSpaces(ans.toLowerCase());
          
          if (id === 'Q1' && (a === '8y - 2' || a === '8y-2')) return true;
          if (id === 'Q2' && (a === '13' || a === '13.0')) return true;
          if (id === 'Q3' && (a === '4a - 8' || a === '4a-8')) return true;
          if (id === 'Q4' && (a === '-2x + 7' || a === '7 - 2x' || a === '-2x+7' || a === '7-2x')) return true;
          if (id === 'Q5' && (/^540\s*\+\s*35h$/.test(a) || /^35h\s*\+\s*540$/.test(a))) return true;
          
          return false;
        }

        window.addEventListener('DOMContentLoaded', () => {
          window.resetApp = resetApp;

          const savedStep = localStorage.getItem('current_step');
          try {
            orderedQuestions = JSON.parse(localStorage.getItem('orderedQuestions')) || orderedQuestions;
            confidenceMap = JSON.parse(localStorage.getItem('confidence')) || {};
          } catch (_) {}

          const debug = getParam('debug') === 'true';
          const panel = document.getElementById('debugPanel');
          if (panel) panel.style.display = debug ? 'block' : 'none';

          showStep(savedStep || 'name');

          if (debug) runUnitTests();
        });

        function logDebug(msg) {
          const box = document.getElementById('debugLog');
          if (box) box.textContent += `\n${new Date().toLocaleTimeString()} ‚Äî ${msg}`;
          console.debug('[DEBUG]', msg);
        }

        function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

        function testSelectQ1Case(name, ordered, conf, expected) {
          const backupOrdered = deepClone(orderedQuestions);
          const backupConf = localStorage.getItem('confidence');

          orderedQuestions = ordered.slice();
          localStorage.setItem('confidence', JSON.stringify(conf));
          const got = selectQ1();
          const pass = got === expected;
          logDebug(`selectQ1 ¬´${name}¬ª: expected ${expected}, got ${got} ‚Äî ${pass ? 'PASS' : 'FAIL'}`);

          orderedQuestions = backupOrdered;
          if (backupConf === null) localStorage.removeItem('confidence'); else localStorage.setItem('confidence', backupConf);
          return pass;
        }

        function testSelectQ2Case(name, ordered, conf, q1id, isCorrect, expected) {
          const backupOrdered = deepClone(orderedQuestions);
          const backupQ1 = localStorage.getItem('q1_id');
          const backupIdx = localStorage.getItem('q1_index');
          const backupConf = localStorage.getItem('confidence');

          orderedQuestions = ordered.slice();
          localStorage.setItem('confidence', JSON.stringify(conf));
          localStorage.setItem('q1_id', q1id);
          localStorage.setItem('q1_index', String(ordered.indexOf(q1id)));
          const got = selectQ2(isCorrect);
          const pass = got === expected;
          logDebug(`selectQ2 ¬´${name}¬ª: expected ${expected}, got ${got} ‚Äî ${pass ? 'PASS' : 'FAIL'}`);

          orderedQuestions = backupOrdered;
          if (backupConf === null) localStorage.removeItem('confidence'); else localStorage.setItem('confidence', backupConf);
          if (backupQ1 === null) localStorage.removeItem('q1_id'); else localStorage.setItem('q1_id', backupQ1);
          if (backupIdx === null) localStorage.removeItem('q1_index'); else localStorage.setItem('q1_index', backupIdx);
          return pass;
        }

        function runUnitTests() {
          logDebug('--- Running unit tests ---');
          const ordered = ['Q1','Q2','Q3','Q4','Q5'];

          testSelectQ1Case('‚â•2 High ‚Üí 2nd hardest high', ordered, {Q4:3,Q5:3}, 'Q4');
          testSelectQ1Case('High + Med ‚Üí hardest high', ordered, {Q5:3,Q3:2}, 'Q5');
          testSelectQ1Case('Only Med ‚Üí easiest med', ordered, {Q2:2,Q3:2}, 'Q2');
          testSelectQ1Case('Med + Low ‚Üí easiest med', ordered, {Q2:2,Q1:1}, 'Q2');
          testSelectQ1Case('Only Low ‚Üí 2nd easiest low', ordered, {Q1:1,Q2:1,Q3:1}, 'Q2');

          testSelectQ2Case('Q1 correct ‚Üí next harder same conf', ordered, {Q2:2,Q3:2,Q4:2}, 'Q3', true, 'Q4');
          testSelectQ2Case('Q1 incorrect ‚Üí next easier same conf', ordered, {Q2:2,Q3:2,Q4:2}, 'Q3', false, 'Q2');
          testSelectQ2Case('No same-conf left ‚Üí fallback to nearest unasked', ordered, {Q1:3}, 'Q1', true, 'Q2');

          logDebug('--- Tests complete ---');
        }
      </script>
   <script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>

<script async="" src="assets/script_cf5a3173.js"></script>
<script>
            window.load_data_from_csv = (filename) => {
                // Implementation needed when code is downloaded
            };

            window.save_data_to_csv = (filename, data) => {
                // Implementation needed when code is downloaded
            };

            window.call_llm = (system_prompt, user_messages, json_fields) => {
                // Implementation needed when code is downloaded
            };
        </script>

    <script async src="assets/script_cf5a3173.js"></script>
<script>
  function proceedToComplete() {
    const reflection = localStorage.getItem('reflection_response');
    if (!reflection) {
      showValidationError('reflectionError', 'Please select how the questions compared to your expectations.');
      return;
    }
    hideValidationError('reflectionError');

    // üîë This must be defined in script_cf5a3173.js
    sendResultsToSheet(); 

    showStep('complete');
  }
</script>
</head>
<body>
<div class="container">
<button class="reset-btn" onclick="resetApp()">Reset üîÑ</button>
<!-- Step 1: Name -->
<section class="step active" id="step-name">
<h2>Enter Your Name</h2>
<div class="field-group">
<input id="firstName" placeholder="First Name" type="text"/>
<input id="lastName" placeholder="Last Name" type="text"/>
</div>
<button id="nameContinue">Continue</button>
</section>
<!-- Step 2: Rank -->
<section class="step" id="step-rank">
<h2>Rank Questions (Easiest to Hardest)</h2>
<p>Use the arrow buttons to arrange the questions from easiest (top) to hardest (bottom).</p>
<div id="rankContainer"></div>
<button onclick="proceedToConfidence()">Next</button>
</section>
<!-- Step 3: Confidence -->
<section class="step" id="step-confidence">
<h2>Rate Your Confidence</h2>
<p>For each question, select how confident you feel about solving it:</p>
<div id="confidenceContainer"></div>
<button onclick="proceedToQ1()">Next</button>
</section>
<!-- Step 4: Q1 -->
<section class="step" id="step-q1">
<h2>Answer This Question</h2>
<div id="q1Container"></div>
</section>
<!-- Step 5: Q2 -->
<section class="step" id="step-q2">
<h2>Next Question</h2>
<div id="q2Container"></div>
</section>
<!-- Step 6: Reflection -->
<section class="step" id="step-reflection">
<h2>Reflection</h2>
<div id="reflectionContainer"></div>
<button onclick="proceedToComplete()">Complete Assessment</button>
</section>
<!-- Step 7: Complete -->
<section class="step" id="step-complete">
<h2>Assessment Complete!</h2>
<p>Thank you for completing the math assessment. Your responses have been saved.</p>
<p>You can now close this window.</p>
</section>
<!-- Debug panel -->
<div id="debugPanel">
<strong>Debug Log</strong>
<pre id="debugLog"></pre>
</div>
</div>
<script>
    // Name step handler
    document.getElementById('nameContinue').addEventListener('click', () => {
      const first = document.getElementById('firstName').value.trim();
      const last = document.getElementById('lastName').value.trim();
      if (!first || !last) {
        alert('Please enter both first and last names.');
        return;
      }
      localStorage.setItem('student_name', JSON.stringify({ first, last }));
      showStep('rank');
    });
  </script>
</body>
</html>

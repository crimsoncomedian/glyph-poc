<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Glyph Assessment</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }
    .container {
      max-width: 600px;
      margin: 2rem auto;
      background: #fff;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 { margin-top: 0; }
    .step { display: none; }
    .step.active { display: block; }
    .field-group { display: flex; gap: 1rem; margin-bottom: 1rem; flex-direction: column; }
    @media (min-width: 480px) {
      .field-group { flex-direction: row; }
    }
    input[type="text"] {
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
    }
    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      background-color: #4f46e5;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 1rem;
    }
    button:hover { background-color: #4338ca; }

    /* Ranking Layout */
    .question-block {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin: 0.5rem 0;
    }
    .question-text {
      flex: 1;
      font-weight: bold;
      word-wrap: break-word;
    }
    .rank-buttons {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 50px;
      align-items: center;
    }
    .rank-buttons button {
      width: 35px;
      height: 28px;
      font-size: 16px;
      padding: 0;
      background-color: #4f46e5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .rank-buttons button:hover {
      background-color: #4338ca;
    }

    .emoji-feedback span {
      font-size: 1.5rem;
      cursor: pointer;
      margin-left: 8px;
    }
    .emoji-selected { transform: scale(1.2); }
  </style>
  <script>
    // ------------------ DATA ------------------
    const questions = [
      { id: 'Q1', label: 'Simplify $3y + 5y - 2$' },
      { id: 'Q2', label: 'Evaluate $m^2 - \\dfrac{12}{m}$, when $m = 4$' },
      { id: 'Q3', label: 'Write $4(a-2)$ with no multiplication' },
      { id: 'Q4', label: 'Simplify $4x - 2(3x - 1) + 5$' },
      { id: 'Q5', label: 'You earn $35$ per hour tutoring. You already have $540$ in your savings. Write an expression for your total money after $h$ hours.' }
    ];

    let orderedQuestions = [...questions.map(q => q.id)];
    let confidenceMap = {};

    // ------------------ STEP HANDLING ------------------
    function showStep(step) {
      document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
      document.getElementById(`step-${step}`).classList.add('active');
      localStorage.setItem('current_step', step);
      if (step === 'rank') renderRank();
      if (step === 'confidence') renderConfidence();
    }

    // ------------------ RANK QUESTIONS ------------------
    function moveQuestion(idx, direction) {
      const newIdx = idx + direction;
      if (newIdx < 0 || newIdx >= orderedQuestions.length) return;
      [orderedQuestions[idx], orderedQuestions[newIdx]] = [orderedQuestions[newIdx], orderedQuestions[idx]];
      localStorage.setItem('orderedQuestions', JSON.stringify(orderedQuestions));
      renderRank();
    }

    function renderRank() {
      const container = document.getElementById('rankContainer');
      container.innerHTML = '';
      orderedQuestions.forEach((id, i) => {
        const q = questions.find(q => q.id === id);
        const div = document.createElement('div');
        div.className = 'question-block';
        div.innerHTML = `
          <div class="question-text">${i + 1}. ${q.label}</div>
          <div class="rank-buttons">
            <button onclick="moveQuestion(${i}, -1)">‚¨ÜÔ∏è</button>
            <button onclick="moveQuestion(${i}, 1)">‚¨áÔ∏è</button>
          </div>
        `;
        container.appendChild(div);
      });
      if (window.MathJax) MathJax.typesetPromise();
    }

    // ------------------ CONFIDENCE SELECTION ------------------
    function renderConfidence() {
      const container = document.getElementById('confidenceContainer');
      container.innerHTML = '';
      orderedQuestions.forEach(id => {
        const q = questions.find(q => q.id === id);
        const div = document.createElement('div');
        div.className = 'question-block';
        div.innerHTML = `
          <div><strong>${q.label}</strong></div>
          <div class="emoji-feedback">
            <span onclick="setConfidence('${id}',1,this)">üòü</span>
            <span onclick="setConfidence('${id}',2,this)">üòê</span>
            <span onclick="setConfidence('${id}',3,this)">üòÑ</span>
          </div>
        `;
        container.appendChild(div);
      });
      if (window.MathJax) MathJax.typesetPromise();
    }

    function setConfidence(qid, value, el) {
      confidenceMap[qid] = value;
      localStorage.setItem('confidence', JSON.stringify(confidenceMap));
      el.parentElement.querySelectorAll('span').forEach(e => e.classList.remove('emoji-selected'));
      el.classList.add('emoji-selected');
    }

    // ------------------ Q1 LOGIC ------------------
    function selectQ1() {
      const confidence = JSON.parse(localStorage.getItem('confidence')) || {};
      const byConf = {1:[],2:[],3:[]};
      orderedQuestions.forEach(q => byConf[confidence[q]].push(q));

      let q1;
      if (byConf[3].length >= 2) q1 = byConf[3][byConf[3].length - 2];
      else if (byConf[3].length >= 1 && byConf[2].length >= 1) q1 = byConf[3][byConf[3].length - 1];
      else if (byConf[2].length >= 1) q1 = byConf[2][0];
      else if (byConf[1].length >= 2) q1 = byConf[1][1];

      localStorage.setItem('q1_id', q1);
      localStorage.setItem('q1_index', orderedQuestions.indexOf(q1));
      return q1;
    }

    // ------------------ Q2 LOGIC ------------------
    function selectQ2(isCorrect) {
      const confidence = JSON.parse(localStorage.getItem('confidence')) || {};
      const q1 = localStorage.getItem('q1_id');
      const q1Idx = parseInt(localStorage.getItem('q1_index'));
      const q1Conf = confidence[q1];

      const unasked = orderedQuestions.filter(q => q !== q1);
      let q2 = null;

      if (isCorrect) {
        for (let i = q1Idx + 1; i < orderedQuestions.length; i++) {
          if (confidence[orderedQuestions[i]] === q1Conf) {
            q2 = orderedQuestions[i];
            break;
          }
        }
      } else {
        for (let i = q1Idx - 1; i >= 0; i--) {
          if (confidence[orderedQuestions[i]] === q1Conf) {
            q2 = orderedQuestions[i];
            break;
          }
        }
      }

      if (!q2) q2 = unasked[0];
      localStorage.setItem('q2_id', q2);
      return q2;
    }

    // ------------------ INIT ------------------
    window.addEventListener('DOMContentLoaded', () => {
      const savedStep = localStorage.getItem('current_step');
      orderedQuestions = JSON.parse(localStorage.getItem('orderedQuestions')) || orderedQuestions;
      confidenceMap = JSON.parse(localStorage.getItem('confidence')) || {};
      showStep(savedStep || 'name');
    });
  </script>
  <script>
    window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }, svg: { fontCache: 'global' } };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
</head>
<body>
  <div class="container">

    <!-- Step 1: Name -->
    <section id="step-name" class="step active">
      <h2>Enter Your Name</h2>
      <div class="field-group">
        <input id="firstName" type="text" placeholder="First Name" />
        <input id="lastName" type="text" placeholder="Last Name" />
      </div>
      <button id="nameContinue">Continue</button>
    </section>

    <!-- Step 2: Rank -->
    <section id="step-rank" class="step">
      <h2>Rank Questions</h2>
      <div id="rankContainer"></div>
      <button onclick="showStep('confidence')">Next</button>
    </section>

    <!-- Step 3: Confidence -->
    <section id="step-confidence" class="step">
      <h2>Rate Your Confidence</h2>
      <div id="confidenceContainer"></div>
      <button onclick="selectQ1(); showStep('complete')">Next</button>
    </section>

    <!-- Step 4: Complete -->
    <section id="step-complete" class="step">
      <h2>Done!</h2>
      <p>Thanks for completing the assessment.</p>
    </section>

  </div>

  <script>
    document.getElementById('nameContinue').addEventListener('click', () => {
      const first = document.getElementById('firstName').value.trim();
      const last = document.getElementById('lastName').value.trim();
      if (!first || !last) {
        alert('Please enter both first and last names.');
        return;
      }
      localStorage.setItem('student_name', JSON.stringify({ first, last }));
      showStep('rank');
    });
  </script>
</body>
</html>
